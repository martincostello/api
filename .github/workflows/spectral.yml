name: spectral

on:
  pull_request:
    branches:
      - main
      - dotnet-vnext
      - dotnet-nightly
  workflow_dispatch:

permissions:
  contents: read

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_MULTILEVEL_LOOKUP: 0
  DOTNET_NOLOGO: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: 1
  NUGET_XMLDOC_MODE: skip
  TERM: xterm

jobs:
  spectral:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4

    - name: Get OpenAPI documents
      id: get-openapi-schemas
      shell: pwsh
      env:
        APPLICATION_URL: 'https://localhost:50001'
      run: |
        Start-Process nohup 'dotnet run --project ./src/API/API.csproj --configuration Release /p:EnableNETAnalyzers=false /p:EnforceCodeStyleInBuild=false'
        $StatusCode = 0
        $Attempts = 0
        While ($Attempts -lt 20) {
          $Response = Try {
            Invoke-WebRequest ${env:APPLICATION_URL} -SkipCertificateCheck
          } catch {
            $_.Exception.Response
          }
          $StatusCode = $Response.StatusCode
          If ($StatusCode -eq 200) {
            break
          }
          $Attempts++
          Start-Sleep -Seconds 5
        }
        If ($StatusCode -ne 200) {
          throw "Failed to successfully connect to website after $Attempts attempts."
        }

        $artifactsPath = (Join-Path ${env:GITHUB_WORKSPACE} "artifacts")
        $schemaPath = (Join-Path $artifactsPath "schema.json")

        if (-Not (Test-Path $artifactsPath)) {
          New-Item -Path ${artifactsPath} -ItemType Directory | Out-Null
        }

        $openApiUrl = "${env:APPLICATION_URL}/swagger/api/swagger.json"
        Invoke-WebRequest $openApiUrl -SkipCertificateCheck -OutFile $schemaPath

        "schemas-path=${artifactsPath}" >> ${env:GITHUB_OUTPUT}

    - name: Install Spectral
      run: npm install -g @stoplight/spectral-cli

    - name: Run Spectral
      env:
        SCHEMAS_PATH: ${{ steps.get-openapi-schemas.outputs.schemas-path }}
      run: |
        spectral lint "${SCHEMAS_PATH}/*.{json,yml,yaml}" --format github-actions --output "${SCHEMAS_PATH}/spectral.json" --quiet

    - name: Publish artifacts
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: artifacts
        path: ${{ steps.get-openapi-schemas.outputs.schemas-path }}
