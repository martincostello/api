name: spectral

on:
  pull_request:
    branches:
      - main
      - dotnet-vnext
      - dotnet-nightly
  workflow_dispatch:

permissions:
  contents: read

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_MULTILEVEL_LOOKUP: 0
  DOTNET_NOLOGO: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: 1
  NUGET_XMLDOC_MODE: skip
  TERM: xterm

jobs:
  spectral:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4

    - name: Get OpenAPI documents
      id: get-openapi
      shell: pwsh
      env:
        APPLICATION_URL: 'https://localhost:5001'
      run: |
        Push-Location (Join-Path "src" "API")
        npm ci
        npm run build
        Pop-Location
        Start-Process nohup 'dotnet run --project ./src/API/API.csproj --configuration Release /p:EnableNETAnalyzers=false /p:EnforceCodeStyleInBuild=false'
        $StatusCode = 0
        $Attempts = 0
        While ($Attempts -lt 20) {
          $Response = Try {
            Invoke-WebRequest ${env:APPLICATION_URL} -SkipCertificateCheck
          } catch {
            $_.Exception.Response
          }
          $StatusCode = $Response.StatusCode
          If ($StatusCode -eq 200) {
            break
          }
          $Attempts++
          Start-Sleep -Seconds 5
        }
        If ($StatusCode -ne 200) {
          throw "Failed to successfully connect to website after $Attempts attempts."
        }
        $openApiUrl = "${env:APPLICATION_URL}/swagger/api/swagger.json"
        $openApi = (Invoke-WebRequest $openApiUrl -SkipCertificateCheck).Content
        "open-api-schema=${openApi}" >> $env:GITHUB_OUTPUT

    - name: Write OpenAPI documents
      id: generate-schemas
      shell: pwsh
      env:
        OPENAPI_SCHEMA: ${{ steps.get-openapi.outputs.open-api-schema }}
      run: |
        $artifactsPath = "${env:GITHUB_WORKSPACE}/artifacts"
        if (-Not (Test-Path $artifactsPath)) {
          New-Item -Path ${artifactsPath} -ItemType Directory | Out-Null
        }
        ${env:OPENAPI_SCHEMA} >> (Join-Path $artifactsPath "schema.json")
        "schemas-path=${openApi}" >> $env:GITHUB_OUTPUT

    - name: Run Spectral
      uses: stoplightio/spectral-action@v0.8.11
      with:
        file_glob: '${{ steps.generate-schemas.outputs.schemas-path }}/*.json'
