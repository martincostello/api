parameters:
  agentOS: 'Windows'
  phaseName: ''
  queueName: ''
  buildArgs: ''
  beforeBuild: []
  afterBuild: []
  variables: {}
  dependsOn: ''
  artifacts:
    archiveName: 'app.zip'
    publish: true

phases:
  - phase: ${{ coalesce(parameters.phaseName, parameters.agentOS) }}
    dependsOn: ${{ parameters.dependsOn }}
    displayName: ${{ coalesce(parameters.phaseName, parameters.agentOS) }}
    queue:
      ${{ if ne(parameters.queueName, '') }}:
        name: ${{ parameters.queueName }}
      ${{ if and(eq(parameters.queueName, ''), eq(parameters.agentOS, 'Linux')) }}:
        name: Hosted Linux Preview
      ${{ if and(eq(parameters.queueName, ''), eq(parameters.agentOS, 'macOS')) }}:
        name: Hosted macOS Preview
      ${{ if and(eq(parameters.queueName, ''), eq(parameters.agentOS, 'Windows')) }}:
        name: Hosted VS2017
    variables:
      AgentOSName: ${{ parameters.agentOS }}
      ArchiveName: ${{ parameters.artifacts.archiveName }}
      BuildArgs: ${{ parameters.buildArgs }}
      ${{ insert }}: ${{ parameters.variables }}
    steps:
      - ${{ parameters.beforeBuild }}
      - ${{ if eq(parameters.agentOS, 'Linux') }}:
        - script: |
            apt-get update
            apt-get install -y --no-install-recommends gettext libcurl4-openssl-dev libicu-dev libssl-dev libunwind8
          name: InstallDotNetCoreDeps
          displayName: Install .NET Core pre-requisites
      - script: |
          npm install -g npm
        name: UpdateNpm
        displayName: Update to latest npm
      - ${{ if eq(parameters.agentOS, 'macOS') }}:
        - script: |
            npm install -g gulp@3.9.1
          name: InstallGulp
          displayName: Install gulp
      - ${{ if eq(parameters.agentOS, 'Windows') }}:
        - powershell: |
            .\Build.ps1 -OutputPath $(Build.StagingDirectory) $(BuildArgs)
          name: BuildAndTest
          displayName: Build and test
          env:
            DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
            NUGET_XMLDOC_MODE: skip
      - ${{ if ne(parameters.agentOS, 'Windows') }}:
        - script: |
            ./build.sh --output $(Build.StagingDirectory) $(BuildArgs)
          name: BuildAndTest
          displayName: Build and test
          env:
            DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
            NUGET_XMLDOC_MODE: skip
      - ${{ if eq(parameters.agentOS, 'Windows') }}:
        - task: ArchiveFiles@2
          name: Package
          displayName: Create deployment package
          inputs:
            rootFolderOrFile: '$(Build.StagingDirectory)/publish'
            includeRootFolder: false
            archiveFile: '$(Build.StagingDirectory)/$(ArchiveName)'
            condition: succeeded()
      - task: PublishTestResults@2
        name: PublishTests
        displayName: Publish test results
        condition: always()
        inputs:
          testRunner: VSTest
          testRunTitle: Unit and integration tests ($(AgentOSName))
          testResultsFiles: $(Build.SourcesDirectory)/**/*.trx
      - ${{ if eq(parameters.agentOS, 'Windows') }}:
        - task: PublishCodeCoverageResults@1
          name: PublishCodeCoverage
          displayName: Publish code coverage
          condition: always()
          inputs:
            codeCoverageTool: cobertura
            reportDirectory: $(Build.StagingDirectory)/**/coverage
            summaryFileLocation: $(Build.StagingDirectory)/**/Cobertura.xml
      - task: PublishBuildArtifacts@1
        displayName: Publish build artifacts
        condition: eq(variables['System.PullRequest.IsFork'], false)
        inputs:
          PathToPublish: '$(Build.StagingDirectory)'
          ArtifactType: Container
          ${{ if eq(parameters.artifacts.name, '') }}:
            ArtifactName: BuildDrop-$(AgentOSName)
          ${{ if ne(parameters.artifacts.name, '') }}:
            ArtifactName: ${{ parameters.artifacts.name }}
      - ${{ if eq(parameters.agentOS, 'Windows') }}:
        - task: PublishBuildArtifacts@1
          displayName: Publish deployment package
          inputs:
            PathtoPublish: '$(Build.StagingDirectory)/$(ArchiveName)'
            ArtifactName: DeploymentPackage
            condition: and(succeeded(), eq(variables['System.PullRequest.IsFork'], false))
      - ${{ parameters.afterBuild }}
